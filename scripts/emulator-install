#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

MODE="${1:-release}"

"${ROOT_DIR}/scripts/require-emulator"

case "${MODE}" in
  debug)
    APK_PATH="${ROOT_DIR}/android/app/build/outputs/apk/debug/app-debug.apk"
    BUILD_CMD=(npm run build:debug)
    ;;
  release)
    APK_PATH="${ROOT_DIR}/android/app/build/outputs/apk/release/app-release.apk"
    BUILD_CMD=(npm run build)
    ;;
  *)
    echo "Usage: emulator-install [release|debug]" >&2
    exit 2
    ;;
esac

if [[ ! -f "${APK_PATH}" ]]; then
  echo "APK not found; building first (${MODE})..." >&2
  (cd "${ROOT_DIR}" && "${BUILD_CMD[@]}")
fi

exec "${ROOT_DIR}/scripts/android-reinstall" "${MODE}"
