#!/usr/bin/env bash
set -euo pipefail

AVD_NAME="${SMT_EMULATOR_AVD_NAME:-spending_api35}"

if ! command -v adb >/dev/null 2>&1; then
  echo "adb not found in PATH" >&2
  exit 1
fi

mapfile -t EMULATOR_SERIALS < <(adb devices | awk 'NR>1 && $1 ~ /^emulator-/ {print $1}')
if [[ "${#EMULATOR_SERIALS[@]}" -eq 0 ]]; then
  echo "No running emulator detected (adb devices shows none)." >&2
  exit 1
fi

for serial in "${EMULATOR_SERIALS[@]}"; do
  out="$(adb -s "${serial}" emu avd name 2>/dev/null || true)"

  # Typical output looks like:
  #   OK
  #   <avd-name>
  # Parse the first non-OK, non-empty line.
  name="$(printf '%s\n' "${out}" | tr -d '\r' | awk 'tolower($0)!="ok" && $0!="" {print $0; exit}')"
  if [[ -n "${name}" && "${name}" == "${AVD_NAME}" ]]; then
    printf '%s\n' "${serial}"
    exit 0
  fi
done

echo "No running emulator matches SMT_EMULATOR_AVD_NAME='${AVD_NAME}'." >&2
echo "Running emulators:" >&2
printf '%s\n' "${EMULATOR_SERIALS[@]}" >&2
exit 1
